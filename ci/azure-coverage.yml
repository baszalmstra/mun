parameters:
  rust: stable

jobs:
- job: ${{ parameters.name }}
  displayName: tarpaulin
  pool:
    vmImage: ubuntu-18.04

  steps:
  - checkout: self
    submodules: true

  - template: azure-install-rust.yml
    parameters: 
      rust: ${{ parameters.rust }}

  - template: azure-install-llvm.yml

  - script: |
      set -e
      wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz
      tar xzf master.tar.gz
      cd kcov-master
      mkdir build
      cd build
      cmake ..
      make
      sudo make install

  - script: cargo install cargo-kcov
    displayName: "Install kcov"

  - script: cargo kcov
    displayName: Run kcov

  - script: bash <(curl -s https://codecov.io/bash)
    displayName: Upload results to codecov
    env:
      CODECOV_TOKEN: ${{ parameters.codecov_token }}